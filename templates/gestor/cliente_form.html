{% extends 'gestor/base_gestor.html' %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Novo{% endif %} Cliente | Portal Comercial{% endblock %}

{% block content %}
<div class="card shadow">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas {% if form.instance.pk %}fa-edit{% else %}fa-plus-circle{% endif %} me-2"></i>
      {% if form.instance.pk %}Editar{% else %}Novo{% endif %} Cliente
    </h5>
    <a href="{% url 'gestor:cliente_list' %}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left me-1"></i> Voltar
    </a>
  </div>
  
  <div class="card-body">
    <form method="post">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {% for error in form.non_field_errors %}
            <p class="mb-0">{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}
      
      <!-- Bloco de Informa√ß√µes Gerais (AGRUPADO COM COMERCIAIS) -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Informa√ß√µes Gerais
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label for="{{ form.codigo.id_for_label }}" class="form-label">C√≥digo*</label>
              {{ form.codigo }}
              {% if form.codigo.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.codigo.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.nome.id_for_label }}" class="form-label">Nome*</label>
              {{ form.nome }}
              {% if form.nome.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.nome.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-3">
              <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
              {{ form.status }}
              {% if form.status.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.status.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-3">
              <label for="{{ form.codigo_master.id_for_label }}" class="form-label">C√≥digo Master</label>
              <div class="input-group">
                {{ form.codigo_master }}
                <button type="button" class="btn btn-outline-secondary" id="buscarMaster">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              {% if form.codigo_master.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.codigo_master.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
              <div id="nomeClienteMaster" class="form-text fw-bold text-primary mt-1"></div>
            </div>
            
            <div class="col-md-9">
              <label for="{{ form.nome_fantasia.id_for_label }}" class="form-label">Nome Fantasia</label>
              {{ form.nome_fantasia }}
              {% if form.nome_fantasia.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.nome_fantasia.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.codigo_loja.id_for_label }}" class="form-label">C√≥digo da Loja</label>
              {{ form.codigo_loja }}
              {% if form.codigo_loja.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.codigo_loja.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.codigo_vendedor.id_for_label }}" class="form-label">C√≥digo Vendedor</label>
              <div class="input-group">
                {{ form.codigo_vendedor }}
                <button type="button" class="btn btn-outline-secondary btn-sm" id="buscarVendedor">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              {% if form.codigo_vendedor.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.codigo_vendedor.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.nome_vendedor.id_for_label }}" class="form-label">Nome do Vendedor</label>
              {{ form.nome_vendedor }}
              {% if form.nome_vendedor.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.nome_vendedor.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.data_cadastro.id_for_label }}" class="form-label">Data Cadastro</label>
              {{ form.data_cadastro }}
              {% if form.data_cadastro.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.data_cadastro.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.data_ultima_compra.id_for_label }}" class="form-label">√öltima Compra</label>
              {{ form.data_ultima_compra }}
              {% if form.data_ultima_compra.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.data_ultima_compra.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Bloco de Dados Fiscais -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-file-invoice me-2"></i>
            Dados Fiscais
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label for="{{ form.tipo_documento.id_for_label }}" class="form-label">Tipo de Documento</label>
              {{ form.tipo_documento }}
              {% if form.tipo_documento.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.tipo_documento.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.cpf_cnpj.id_for_label }}" class="form-label">CPF/CNPJ</label>
              <div class="input-group">
                {{ form.cpf_cnpj }}
                <button type="button" class="btn btn-outline-primary" id="consultarReceita">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
              {% if form.cpf_cnpj.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.cpf_cnpj.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-5">
              <label for="{{ form.nome_razao_social.id_for_label }}" class="form-label">Raz√£o Social</label>
              {{ form.nome_razao_social }}
              {% if form.nome_razao_social.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.nome_razao_social.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.inscricao_estadual.id_for_label }}" class="form-label">Inscri√ß√£o Estadual/RG</label>
              {{ form.inscricao_estadual }}
              {% if form.inscricao_estadual.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.inscricao_estadual.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.inscricao_municipal.id_for_label }}" class="form-label">Inscri√ß√£o Municipal</label>
              {{ form.inscricao_municipal }}
              {% if form.inscricao_municipal.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.inscricao_municipal.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.situacao_cadastral.id_for_label }}" class="form-label">Situa√ß√£o Cadastral</label>
              <div class="input-group">
                {{ form.situacao_cadastral }}
                <button type="button" class="btn btn-outline-info btn-sm" id="infoSituacao" 
                        data-bs-toggle="tooltip" 
                        title="Situa√ß√£o do CPF/CNPJ na Receita Federal">
                  <i class="fas fa-info-circle"></i>
                </button>
              </div>
              {% if form.situacao_cadastral.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.situacao_cadastral.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Bloco de Endere√ßo -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-map-marker-alt me-2"></i>
            Endere√ßo
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-2">
              <label for="{{ form.tipo_logradouro.id_for_label }}" class="form-label">Tipo</label>
              {{ form.tipo_logradouro }}
              {% if form.tipo_logradouro.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.tipo_logradouro.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.endereco.id_for_label }}" class="form-label">Logradouro</label>
              {{ form.endereco }}
              {% if form.endereco.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.endereco.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.numero.id_for_label }}" class="form-label">N√∫mero</label>
              {{ form.numero }}
              {% if form.numero.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.numero.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.complemento.id_for_label }}" class="form-label">Complemento</label>
              {{ form.complemento }}
              {% if form.complemento.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.complemento.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.bairro.id_for_label }}" class="form-label">Bairro</label>
              {{ form.bairro }}
              {% if form.bairro.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.bairro.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.cidade.id_for_label }}" class="form-label">Cidade</label>
              {{ form.cidade }}
              {% if form.cidade.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.cidade.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.estado.id_for_label }}" class="form-label">UF</label>
              {{ form.estado }}
              {% if form.estado.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.estado.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.cep.id_for_label }}" class="form-label">CEP</label>
              {{ form.cep }}
              {% if form.cep.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.cep.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Bloco de Informa√ß√µes da Receita Federal -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-landmark me-2"></i>
            Informa√ß√µes da Receita Federal
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="{{ form.cnae_principal.id_for_label }}" class="form-label">CNAE Principal</label>
              {{ form.cnae_principal }}
              {% if form.cnae_principal.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.cnae_principal.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.cnae_descricao.id_for_label }}" class="form-label">Descri√ß√£o CNAE</label>
              {{ form.cnae_descricao }}
              {% if form.cnae_descricao.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.cnae_descricao.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.porte_empresa.id_for_label }}" class="form-label">Porte da Empresa</label>
              {{ form.porte_empresa }}
              {% if form.porte_empresa.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.porte_empresa.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.natureza_juridica.id_for_label }}" class="form-label">Natureza Jur√≠dica</label>
              {{ form.natureza_juridica }}
              {% if form.natureza_juridica.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.natureza_juridica.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.data_abertura.id_for_label }}" class="form-label">Data de Abertura</label>
              {{ form.data_abertura }}
              {% if form.data_abertura.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.data_abertura.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.data_ultima_verificacao.id_for_label }}" class="form-label">Data da √öltima Consulta</label>
              {{ form.data_ultima_verificacao }}
              {% if form.data_ultima_verificacao.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.data_ultima_verificacao.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-3">
              <div class="form-check form-switch mt-4">
                {{ form.opcao_pelo_simples }}
                <label class="form-check-label" for="{{ form.opcao_pelo_simples.id_for_label }}">Optante pelo Simples</label>
              </div>
              {% if form.opcao_pelo_simples.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.opcao_pelo_simples.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-3">
              <div class="form-check form-switch mt-4">
                {{ form.opcao_pelo_mei }}
                <label class="form-check-label" for="{{ form.opcao_pelo_mei.id_for_label }}">Optante pelo MEI</label>
              </div>
              {% if form.opcao_pelo_mei.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.opcao_pelo_mei.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- BLOCO DE CNAES SECUND√ÅRIOS -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-list-alt me-2"></i>
            CNAEs Secund√°rios
          </h5>
          <button type="button" class="btn btn-outline-primary btn-sm" id="adicionarCnae">
            <i class="fas fa-plus me-1"></i> Adicionar CNAE
          </button>
        </div>
        <div class="card-body">
          <div id="cnaes-container">
            {{ cnaes_formset.management_form }}
            {% for form_cnae in cnaes_formset %}
              <div class="cnae-form-row" data-form-index="{{ forloop.counter0 }}">
                {% for hidden in form_cnae.hidden_fields %}
                  {{ hidden }}
                {% endfor %}
                <div class="row g-3 mb-3">
                  <div class="col-md-3">
                    <label class="form-label">C√≥digo CNAE</label>
                    {{ form_cnae.codigo_cnae }}
                    {% if form_cnae.codigo_cnae.errors %}
                      <div class="text-danger small mt-1">
                        {% for error in form_cnae.codigo_cnae.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Descri√ß√£o</label>
                    {{ form_cnae.descricao_cnae }}
                    {% if form_cnae.descricao_cnae.errors %}
                      <div class="text-danger small mt-1">
                        {% for error in form_cnae.descricao_cnae.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Ordem</label>
                    {{ form_cnae.ordem }}
                    {% if form_cnae.ordem.errors %}
                      <div class="text-danger small mt-1">
                        {% for error in form_cnae.ordem.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <div>
                      {% if form_cnae.instance.pk %}
                        {{ form_cnae.DELETE }}
                        <label for="{{ form_cnae.DELETE.id_for_label }}" class="btn btn-outline-danger btn-sm">
                          <i class="fas fa-trash"></i>
                        </label>
                      {% else %}
                        <button type="button" class="btn btn-outline-danger btn-sm remover-cnae">
                          <i class="fas fa-trash"></i>
                        </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
          
          <!-- Template para novos CNAEs -->
          <div id="cnae-template" style="display: none;">
            <div class="cnae-form-row" data-form-index="__prefix__">
              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <label class="form-label">C√≥digo CNAE</label>
                  <input type="text" name="cnaes-__prefix__-codigo_cnae" class="form-control" placeholder="Ex: 4761003">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Descri√ß√£o</label>
                  <input type="text" name="cnaes-__prefix__-descricao_cnae" class="form-control" placeholder="Descri√ß√£o da atividade">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Ordem</label>
                  <input type="number" name="cnaes-__prefix__-ordem" class="form-control" value="1" min="1">
                </div>
                <div class="col-md-1">
                  <label class="form-label">&nbsp;</label>
                  <div>
                    <button type="button" class="btn btn-outline-danger btn-sm remover-cnae">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bloco de Contato -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-phone me-2"></i>
            Informa√ß√µes de Contato
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="{{ form.telefone.id_for_label }}" class="form-label">Telefone</label>
              {{ form.telefone }}
              {% if form.telefone.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.telefone.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
              {{ form.email }}
              {% if form.email.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.email.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="col-12">
              <label for="{{ form.observacoes.id_for_label }}" class="form-label">Observa√ß√µes</label>
              {{ form.observacoes }}
              {% if form.observacoes.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.observacoes.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Bot√µes de a√ß√£o -->
      <div class="d-flex justify-content-end mt-4">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-1"></i> Salvar
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // ===== NORMALIZA√á√ÉO DA SITUA√á√ÉO CADASTRAL =====
  function normalizarSituacaoCadastral(situacao) {
    const mapeamento = {
      '1': '01',
      '2': '02', 
      '3': '03',
      '4': '04',
      '8': '08',
      '2.0': '02',
      '3.0': '03',
      '4.0': '04', 
      '8.0': '08'
    };
    
    return mapeamento[situacao] || situacao;
  }
  
  // ===== BUSCAR VENDEDOR AUTOMATICAMENTE - CORRIGIDO =====
  const codigoVendedorInput = document.getElementById('id_codigo_vendedor');
  const nomeVendedorInput = document.getElementById('id_nome_vendedor');
  const btnBuscarVendedor = document.getElementById('buscarVendedor');

  if (codigoVendedorInput && nomeVendedorInput) {
    
    // Fun√ß√£o para buscar vendedor
    function buscarVendedor(codigo) {
      if (!codigo || codigo.length !== 3) {
        nomeVendedorInput.value = '';
        nomeVendedorInput.classList.remove('is-valid', 'is-invalid');
        return;
      }
      
      // Indicador visual de carregamento
      nomeVendedorInput.value = 'Buscando...';
      nomeVendedorInput.classList.remove('is-valid', 'is-invalid');
      
      fetch(`/gestor/api/vendedor-por-codigo/${codigo}/`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            nomeVendedorInput.value = data.nome;
            nomeVendedorInput.classList.add('is-valid');
            nomeVendedorInput.classList.remove('is-invalid');
            
            // Mostrar informa√ß√£o da loja se dispon√≠vel
            if (data.loja) {
              nomeVendedorInput.setAttribute('title', `Loja: ${data.loja}`);
            }
          } else {
            nomeVendedorInput.value = '';
            nomeVendedorInput.classList.add('is-invalid');
            nomeVendedorInput.classList.remove('is-valid');
            nomeVendedorInput.setAttribute('title', data.message || 'Vendedor n√£o encontrado');
          }
        })
        .catch(error => {
          console.error('Erro ao buscar vendedor:', error);
          nomeVendedorInput.value = '';
          nomeVendedorInput.classList.add('is-invalid');
          nomeVendedorInput.setAttribute('title', 'Erro ao buscar vendedor');
        });
    }
    
    // Event listeners
    let timeoutId;
    
    // Bot√£o de busca manual
    if (btnBuscarVendedor) {
      btnBuscarVendedor.addEventListener('click', function() {
        const codigo = codigoVendedorInput.value.trim();
        buscarVendedor(codigo);
      });
    }
    
    // Buscar quando sair do campo (blur)
    codigoVendedorInput.addEventListener('blur', function() {
      const codigo = this.value.trim();
      buscarVendedor(codigo);
    });
    
    // Buscar com delay enquanto digita (input)
    codigoVendedorInput.addEventListener('input', function() {
      const codigo = this.value.trim();
      
      // Limpar timeout anterior
      clearTimeout(timeoutId);
      
      // Se campo vazio, limpar nome imediatamente
      if (!codigo) {
        nomeVendedorInput.value = '';
        nomeVendedorInput.classList.remove('is-valid', 'is-invalid');
        return;
      }
      
      // Se tem 3 d√≠gitos, buscar ap√≥s 800ms de pausa
      if (codigo.length === 3) {
        timeoutId = setTimeout(() => {
          buscarVendedor(codigo);
        }, 800);
      }
    });
    
    // Valida√ß√£o em tempo real do c√≥digo
    codigoVendedorInput.addEventListener('input', function() {
      const codigo = this.value.trim();
      
      // Validar formato (3 d√≠gitos num√©ricos)
      if (codigo && (codigo.length !== 3 || !/^\d{3}$/.test(codigo))) {
        this.classList.add('is-invalid');
        this.classList.remove('is-valid');
      } else if (codigo.length === 3) {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
      } else {
        this.classList.remove('is-valid', 'is-invalid');
      }
    });
  }

  // ===== CONSULTA RECEITA FEDERAL - CORRIGIDA =====
  const btnConsultarReceita = document.getElementById('consultarReceita');
  const cpfCnpjInput = document.getElementById('id_cpf_cnpj');
  
  if (btnConsultarReceita && cpfCnpjInput) {
    btnConsultarReceita.addEventListener('click', function() {
      const cpfCnpj = cpfCnpjInput.value.trim().replace(/[^\d]/g, '');
      
      if (cpfCnpj) {
        btnConsultarReceita.disabled = true;
        btnConsultarReceita.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        fetch(`/gestor/api/consultar-receita/${cpfCnpj}/`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const dados = data.dados;
              
              // Preencher campos b√°sicos
              if (dados.razaoSocial) document.getElementById('id_nome_razao_social').value = dados.razaoSocial;
              if (dados.nomeFantasia) document.getElementById('id_nome_fantasia').value = dados.nomeFantasia;
              
              // *** SITUA√á√ÉO CADASTRAL NORMALIZADA ***
              if (dados.situacaoCadastral) {
                const situacaoNormalizada = normalizarSituacaoCadastral(dados.situacaoCadastral);
                const situacaoSelect = document.getElementById('id_situacao_cadastral');
                
                // Definir o valor normalizado
                situacaoSelect.value = situacaoNormalizada;
                
                // Se o valor n√£o existe nas options, adicionar temporariamente
                if (!situacaoSelect.querySelector(`option[value="${situacaoNormalizada}"]`)) {
                  const opcaoTemp = new Option(dados.situacaoCadastral, situacaoNormalizada, true, true);
                  situacaoSelect.appendChild(opcaoTemp);
                }
              }
              
              if (dados.naturezaJuridica) document.getElementById('id_natureza_juridica').value = dados.naturezaJuridica;
              if (dados.porteEmpresa) document.getElementById('id_porte_empresa').value = dados.porteEmpresa;
              if (dados.dataAbertura) document.getElementById('id_data_abertura').value = dados.dataAbertura;
              
              // Preencher CNAE principal
              if (dados.cnaeFiscal) {
                document.getElementById('id_cnae_principal').value = dados.cnaeFiscal;
                document.getElementById('id_cnae_descricao').value = dados.cnaeFiscalDescricao || '';
              }
              
              // Atualizar data da consulta
              document.getElementById('id_data_ultima_verificacao').value = new Date().toISOString().slice(0, 16);
              
              // Atualizar op√ß√µes tribut√°rias
              if (dados.optanteSimples !== undefined) {
                document.getElementById('id_opcao_pelo_simples').checked = dados.optanteSimples;
              }
              if (dados.optanteMei !== undefined) {
                document.getElementById('id_opcao_pelo_mei').checked = dados.optanteMei;
              }
              
              // PROCESSAR CNAES SECUND√ÅRIOS
              if (dados.cnaesSecundarios && dados.cnaesSecundarios.length > 0) {
                adicionarCnaesSecundarios(dados.cnaesSecundarios);
              }
              
              // Mostrar situa√ß√£o de forma amig√°vel
              mostrarStatusSituacao(dados.situacaoCadastral);
              
              alert(`‚úÖ Dados atualizados!\nüè¢ CNAE principal: ${dados.cnaeFiscal || 'N/A'}\nüìã CNAEs secund√°rios: ${dados.cnaesSecundarios?.length || 0}`);
            } else {
              alert(data.message || 'Erro ao consultar dados na Receita Federal');
            }
          })
          .catch(error => {
            console.error('Erro na consulta:', error);
            alert('Erro ao realizar a consulta.');
          })
          .finally(() => {
            btnConsultarReceita.disabled = false;
            btnConsultarReceita.innerHTML = '<i class="fas fa-sync-alt"></i>';
          });
      } else {
        alert('Informe um CPF/CNPJ v√°lido para consulta');
      }
    });
  }
  
  // ===== FUN√á√ÉO PARA MOSTRAR STATUS DA SITUA√á√ÉO =====
  function mostrarStatusSituacao(situacao) {
    const situacaoNormalizada = normalizarSituacaoCadastral(situacao);
    
    // Remover status anterior se existir
    const statusAnterior = document.querySelector('#situacao-display');
    if (statusAnterior) {
      statusAnterior.remove();
    }
    
    const situacaoTexto = {
      '02': '‚úÖ Empresa ATIVA na Receita Federal',
      '03': '‚ö†Ô∏è Empresa SUSPENSA na Receita Federal', 
      '04': '‚ùå Empresa INAPTA na Receita Federal',
      '08': 'üîí Empresa BAIXADA na Receita Federal',
      '01': '‚ùì Situa√ß√£o NULA na Receita Federal'
    };
    
    const situacaoDisplay = document.createElement('div');
    situacaoDisplay.id = 'situacao-display';
    situacaoDisplay.className = 'alert alert-info mt-2';
    situacaoDisplay.innerHTML = situacaoTexto[situacaoNormalizada] || `üìÑ Situa√ß√£o: ${situacao}`;
    
    // Inserir ap√≥s o campo de situa√ß√£o cadastral
    const situacaoField = document.getElementById('id_situacao_cadastral').closest('.col-md-4');
    situacaoField.appendChild(situacaoDisplay);
  }
  
  // ===== BUSCAR CLIENTE MASTER - CORRIGIDO =====
  const btnBuscarMaster = document.getElementById('buscarMaster');
  const codigoMasterInput = document.getElementById('id_codigo_master');
  const nomeClienteMaster = document.getElementById('nomeClienteMaster');
  
  if (btnBuscarMaster && codigoMasterInput) {
    btnBuscarMaster.addEventListener('click', function() {
      const codigoMaster = codigoMasterInput.value.trim();
      if (codigoMaster) {
        fetch(`/gestor/api/cliente-por-codigo/${codigoMaster}/`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              nomeClienteMaster.textContent = `${data.nome} (${data.status})`;
              nomeClienteMaster.className = 'form-text fw-bold text-success mt-1';
            } else {
              nomeClienteMaster.textContent = data.message || 'Cliente master n√£o encontrado';
              nomeClienteMaster.className = 'form-text fw-bold text-danger mt-1';
            }
          })
          .catch(error => {
            console.error('Erro ao buscar cliente master:', error);
            nomeClienteMaster.textContent = 'Erro ao buscar cliente master';
            nomeClienteMaster.className = 'form-text fw-bold text-danger mt-1';
          });
      } else {
        nomeClienteMaster.textContent = '';
      }
    });
  }
  
  // ===== GERENCIAMENTO DE CNAES SECUND√ÅRIOS =====
  let formsetIndex = document.querySelectorAll('.cnae-form-row').length;
  
  // Fun√ß√£o para adicionar CNAEs vindos da Receita Federal
  function adicionarCnaesSecundarios(cnaesData) {
    const container = document.getElementById('cnaes-container');
    
    cnaesData.forEach((cnae, index) => {
      const novoFormIndex = formsetIndex++;
      const template = document.getElementById('cnae-template');
      const novoForm = template.cloneNode(true);
      
      novoForm.style.display = 'block';
      novoForm.id = '';
      novoForm.className = 'cnae-form-row';
      novoForm.setAttribute('data-form-index', novoFormIndex);
      
      // Substituir __prefix__ pelo √≠ndice real
      novoForm.innerHTML = novoForm.innerHTML.replace(/__prefix__/g, novoFormIndex);
      
      // Preencher valores
      novoForm.querySelector(`input[name="cnaes-${novoFormIndex}-codigo_cnae"]`).value = cnae.codigo;
      novoForm.querySelector(`input[name="cnaes-${novoFormIndex}-descricao_cnae"]`).value = cnae.descricao;
      novoForm.querySelector(`input[name="cnaes-${novoFormIndex}-ordem"]`).value = index + 1;
      
      container.appendChild(novoForm);
    });
    
    // Atualizar total forms
    atualizarTotalForms();
  }
  
  // Bot√£o para adicionar CNAE manualmente
  const btnAdicionarCnae = document.getElementById('adicionarCnae');
  if (btnAdicionarCnae) {
    btnAdicionarCnae.addEventListener('click', function() {
      const container = document.getElementById('cnaes-container');
      const template = document.getElementById('cnae-template');
      const novoFormIndex = formsetIndex++;
      
      const novoForm = template.cloneNode(true);
      novoForm.style.display = 'block';
      novoForm.id = '';
      novoForm.className = 'cnae-form-row';
      novoForm.setAttribute('data-form-index', novoFormIndex);
      
      // Substituir __prefix__ pelo √≠ndice real
      novoForm.innerHTML = novoForm.innerHTML.replace(/__prefix__/g, novoFormIndex);
      
      container.appendChild(novoForm);
      atualizarTotalForms();
    });
  }
  
  // Event delegation para bot√µes de remover
  document.addEventListener('click', function(e) {
    if (e.target.closest('.remover-cnae')) {
      e.preventDefault();
      const formRow = e.target.closest('.cnae-form-row');
      formRow.remove();
      atualizarTotalForms();
    }
  });
  
  // Fun√ß√£o para atualizar o total de forms do formset
  function atualizarTotalForms() {
    const totalForms = document.getElementById('id_cnaes-TOTAL_FORMS');
    if (totalForms) {
      totalForms.value = document.querySelectorAll('.cnae-form-row').length;
    }
  }
  
  // ===== INICIALIZAR TOOLTIPS =====
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // ===== CSS ADICIONAL =====
  const style = document.createElement('style');
  style.textContent = `
    .badge {
      font-size: 0.75rem;
      padding: 0.4rem 0.6rem;
    }
    
    .badge .fas {
      font-size: 0.7rem;
    }
    
    #infoSituacao {
      border-left: none;
    }
    
    .is-valid {
      border-color: #198754;
    }
    
    .is-invalid {
      border-color: #dc3545;
    }
    
    .form-control:read-only {
      background-color: #f8f9fa;
      border-color: #dee2e6;
    }
    
    .alert-info {
      --bs-alert-color: #055160;
      --bs-alert-bg: #cff4fc;
      --bs-alert-border-color: #b6effb;
    }
    
    .cnae-form-row {
      border-left: 3px solid #e9ecef;
      padding-left: 1rem;
      margin-bottom: 1rem;
    }
    
    .cnae-form-row:hover {
      border-left-color: #007bff;
      background-color: #f8f9fa;
    }
  `;
  document.head.appendChild(style);
});
</script>

{% endblock %}
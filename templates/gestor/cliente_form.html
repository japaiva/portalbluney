{% extends 'gestor/base_gestor.html' %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Novo{% endif %} Cliente | Portal Comercial{% endblock %}

{% block content %}
<div class="card shadow">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas {% if form.instance.pk %}fa-edit{% else %}fa-plus-circle{% endif %} me-2"></i>
      {% if form.instance.pk %}Editar{% else %}Novo{% endif %} Cliente
    </h5>
    <a href="{% url 'gestor:cliente_list' %}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left me-1"></i> Voltar
    </a>
  </div>
  
  <div class="card-body">
    <form method="post">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {% for error in form.non_field_errors %}
            <p class="mb-0">{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}
      
      <!-- Bloco de Informações Principais -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Informações Principais
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label for="{{ form.codigo.id_for_label }}" class="form-label">Código*</label>
              {{ form.codigo }}
              {% if form.codigo.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.codigo.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.nome.id_for_label }}" class="form-label">Nome*</label>
              {{ form.nome }}
              {% if form.nome.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.nome.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-3">
              <label for="{{ form.codigo_master.id_for_label }}" class="form-label">Código Master</label>
              <div class="input-group">
                {{ form.codigo_master }}
                <button type="button" class="btn btn-outline-secondary" id="buscarMaster">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              {% if form.codigo_master.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.codigo_master.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
              <div class="form-text small text-muted">
                Deixe em branco se este for um cliente principal.
              </div>
              <div id="nomeClienteMaster" class="form-text fw-bold text-primary mt-1"></div>
            </div>
            
            <div class="col-md-12">
              <label for="{{ form.nome_fantasia.id_for_label }}" class="form-label">Nome Fantasia</label>
              {{ form.nome_fantasia }}
              {% if form.nome_fantasia.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.nome_fantasia.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Bloco de Dados Fiscais -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-file-invoice me-2"></i>
            Dados Fiscais
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label for="{{ form.tipo_documento.id_for_label }}" class="form-label">Tipo de Documento</label>
              {{ form.tipo_documento }}
              {% if form.tipo_documento.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.tipo_documento.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.cpf_cnpj.id_for_label }}" class="form-label">CPF/CNPJ</label>
              <div class="input-group">
                {{ form.cpf_cnpj }}
                <button type="button" class="btn btn-outline-primary" id="consultarReceita">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
              {% if form.cpf_cnpj.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.cpf_cnpj.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-5">
              <label for="{{ form.nome_razao_social.id_for_label }}" class="form-label">Razão Social</label>
              {{ form.nome_razao_social }}
              {% if form.nome_razao_social.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.nome_razao_social.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.inscricao_estadual.id_for_label }}" class="form-label">Inscrição Estadual/RG</label>
              {{ form.inscricao_estadual }}
              {% if form.inscricao_estadual.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.inscricao_estadual.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.inscricao_municipal.id_for_label }}" class="form-label">Inscrição Municipal</label>
              {{ form.inscricao_municipal }}
              {% if form.inscricao_municipal.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.inscricao_municipal.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.situacao_cadastral.id_for_label }}" class="form-label">Situação Cadastral</label>
              {{ form.situacao_cadastral }}
              {% if form.situacao_cadastral.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.situacao_cadastral.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Bloco de Endereço -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-map-marker-alt me-2"></i>
            Endereço
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-2">
              <label for="{{ form.tipo_logradouro.id_for_label }}" class="form-label">Tipo</label>
              {{ form.tipo_logradouro }}
              {% if form.tipo_logradouro.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.tipo_logradouro.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.endereco.id_for_label }}" class="form-label">Logradouro</label>
              {{ form.endereco }}
              {% if form.endereco.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.endereco.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.numero.id_for_label }}" class="form-label">Número</label>
              {{ form.numero }}
              {% if form.numero.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.numero.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.complemento.id_for_label }}" class="form-label">Complemento</label>
              {{ form.complemento }}
              {% if form.complemento.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.complemento.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.bairro.id_for_label }}" class="form-label">Bairro</label>
              {{ form.bairro }}
              {% if form.bairro.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.bairro.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.cidade.id_for_label }}" class="form-label">Cidade</label>
              {{ form.cidade }}
              {% if form.cidade.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.cidade.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.estado.id_for_label }}" class="form-label">UF</label>
              {{ form.estado }}
              {% if form.estado.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.estado.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-2">
              <label for="{{ form.cep.id_for_label }}" class="form-label">CEP</label>
              {{ form.cep }}
              {% if form.cep.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.cep.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Bloco de Informações da Receita Federal -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-landmark me-2"></i>
            Informações da Receita Federal
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="{{ form.cnae_principal.id_for_label }}" class="form-label">CNAE Principal</label>
              {{ form.cnae_principal }}
              {% if form.cnae_principal.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.cnae_principal.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.cnae_descricao.id_for_label }}" class="form-label">Descrição CNAE</label>
              {{ form.cnae_descricao }}
              {% if form.cnae_descricao.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.cnae_descricao.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.porte_empresa.id_for_label }}" class="form-label">Porte da Empresa</label>
              {{ form.porte_empresa }}
              {% if form.porte_empresa.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.porte_empresa.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.natureza_juridica.id_for_label }}" class="form-label">Natureza Jurídica</label>
              {{ form.natureza_juridica }}
              {% if form.natureza_juridica.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.natureza_juridica.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-4">
              <label for="{{ form.data_abertura.id_for_label }}" class="form-label">Data de Abertura</label>
              {{ form.data_abertura }}
              {% if form.data_abertura.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.data_abertura.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.data_ultima_verificacao.id_for_label }}" class="form-label">Data da Última Consulta</label>
              {{ form.data_ultima_verificacao }}
              {% if form.data_ultima_verificacao.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.data_ultima_verificacao.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-3">
              <div class="form-check form-switch mt-4">
                {{ form.opcao_pelo_simples }}
                <label class="form-check-label" for="{{ form.opcao_pelo_simples.id_for_label }}">Optante pelo Simples</label>
              </div>
              {% if form.opcao_pelo_simples.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.opcao_pelo_simples.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-3">
              <div class="form-check form-switch mt-4">
                {{ form.opcao_pelo_mei }}
                <label class="form-check-label" for="{{ form.opcao_pelo_mei.id_for_label }}">Optante pelo MEI</label>
              </div>
              {% if form.opcao_pelo_mei.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.opcao_pelo_mei.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>


      <!-- Adicionar esta seção APÓS o bloco "Informações da Receita Federal" -->

      <!-- Bloco de CNAEs Secundários -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-industry me-2"></i>
            CNAEs Secundários
          </h5>
          <button type="button" class="btn btn-sm btn-success" id="adicionarCnae">
            <i class="fas fa-plus me-1"></i> Adicionar CNAE
          </button>
        </div>
        <div class="card-body">
          <!-- Mostrar CNAE Principal como referência -->
          <div class="alert alert-info mb-3">
            <strong>CNAE Principal:</strong> 
            <span id="cnae-principal-display">
              {% if form.cnae_principal.value %}
                {{ form.cnae_principal.value }} - {{ form.cnae_descricao.value|default:"" }}
              {% else %}
                Não informado
              {% endif %}
            </span>
          </div>

          <!-- FormSet Management Form (obrigatório para Django FormSets) -->
          {{ cnaes_formset.management_form }}
          
          <!-- Container para CNAEs Secundários -->
          <div id="cnaes-container">
            {% for cnae_form in cnaes_formset %}
              <div class="cnae-item border rounded p-3 mb-3" data-form-index="{{ forloop.counter0 }}">
                <div class="row g-3">
                  <div class="col-md-2">
                    <label class="form-label">Ordem</label>
                    {{ cnae_form.ordem }}
                    {% if cnae_form.ordem.errors %}
                      <div class="text-danger small">{{ cnae_form.ordem.errors.0 }}</div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-3">
                    <label class="form-label">Código CNAE*</label>
                    {{ cnae_form.codigo_cnae }}
                    {% if cnae_form.codigo_cnae.errors %}
                      <div class="text-danger small">{{ cnae_form.codigo_cnae.errors.0 }}</div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label">Descrição*</label>
                    {{ cnae_form.descricao_cnae }}
                    {% if cnae_form.descricao_cnae.errors %}
                      <div class="text-danger small">{{ cnae_form.descricao_cnae.errors.0 }}</div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-1 d-flex align-items-end">
                    {% if cnae_form.instance.pk %}
                      {{ cnae_form.DELETE }}
                      <label for="{{ cnae_form.DELETE.id_for_label }}" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-trash"></i>
                      </label>
                    {% else %}
                      <button type="button" class="btn btn-outline-danger btn-sm remover-cnae">
                        <i class="fas fa-trash"></i>
                      </button>
                    {% endif %}
                  </div>
                </div>
                
                <!-- Hidden fields para o FormSet -->
                {% for hidden in cnae_form.hidden_fields %}
                  {{ hidden }}
                {% endfor %}
              </div>
            {% endfor %}
          </div>
          
          <!-- Template para novos CNAEs (hidden) -->
          <div id="cnae-template" class="cnae-item border rounded p-3 mb-3 d-none">
            <div class="row g-3">
              <div class="col-md-2">
                <label class="form-label">Ordem</label>
                <input type="number" class="form-control" name="__prefix__-ordem" min="1" value="1">
              </div>
              
              <div class="col-md-3">
                <label class="form-label">Código CNAE*</label>
                <input type="text" class="form-control" name="__prefix__-codigo_cnae" maxlength="10" placeholder="Ex: 4761003">
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Descrição*</label>
                <input type="text" class="form-control" name="__prefix__-descricao_cnae" placeholder="Descrição da atividade">
              </div>
              
              <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-sm remover-cnae">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
          
          {% if not cnaes_formset %}
            <div class="text-muted text-center py-3">
              <i class="fas fa-info-circle me-2"></i>
              Nenhum CNAE secundário cadastrado. Use o botão "Adicionar CNAE" para incluir atividades secundárias.
            </div>
          {% endif %}
        </div>
      </div>



      <!-- Bloco de Informações Comerciais -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-shopping-cart me-2"></i>
            Informações Comerciais
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label for="{{ form.codigo_loja.id_for_label }}" class="form-label">Código da Loja</label>
              {{ form.codigo_loja }}
              {% if form.codigo_loja.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.codigo_loja.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-3">
              <label for="{{ form.codigo_vendedor.id_for_label }}" class="form-label">Código do Vendedor</label>
              {{ form.codigo_vendedor }}
              {% if form.codigo_vendedor.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.codigo_vendedor.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.nome_vendedor.id_for_label }}" class="form-label">Nome do Vendedor</label>
              {{ form.nome_vendedor }}
              {% if form.nome_vendedor.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.nome_vendedor.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.data_cadastro.id_for_label }}" class="form-label">Data de Cadastro</label>
              {{ form.data_cadastro }}
              {% if form.data_cadastro.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.data_cadastro.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.data_ultima_compra.id_for_label }}" class="form-label">Data da Última Compra</label>
              {{ form.data_ultima_compra }}
              {% if form.data_ultima_compra.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.data_ultima_compra.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Bloco de Contato -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-phone me-2"></i>
            Informações de Contato
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="{{ form.telefone.id_for_label }}" class="form-label">Telefone</label>
              {{ form.telefone }}
              {% if form.telefone.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.telefone.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
              {{ form.email }}
              {% if form.email.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.email.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="col-12">
              <label for="{{ form.observacoes.id_for_label }}" class="form-label">Observações</label>
              {{ form.observacoes }}
              {% if form.observacoes.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.observacoes.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-12">
              <div class="form-check form-switch mt-2">
                {{ form.ativo }}
                <label class="form-check-label" for="{{ form.ativo.id_for_label }}">Cliente Ativo</label>
              </div>
              {% if form.ativo.errors %}
                <div class="text-danger small mt-1">
                  {% for error in form.ativo.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Botões de ação -->
      <div class="d-flex justify-content-end mt-4">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-1"></i> Salvar
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ===== VARIÁVEIS GLOBAIS =====
  let formIndex = {{ cnaes_formset.total_form_count|default:0 }};
  const maxForms = {{ cnaes_formset.max_num|default:10 }};
  
  // ===== FUNÇÕES DE GERENCIAMENTO DE CNAEs =====
  
  function updateTotalForms() {
    const totalFormsInput = document.querySelector('input[name="cnaes-TOTAL_FORMS"]');
    if (totalFormsInput) {
      totalFormsInput.value = formIndex;
    }
  }
  
  function reorderCnaes() {
    const container = document.getElementById('cnaes-container');
    const forms = container.querySelectorAll('.cnae-item:not(.d-none)');
    
    forms.forEach((form, index) => {
      const ordemInput = form.querySelector('input[name$="-ordem"]');
      if (ordemInput) {
        ordemInput.value = index + 1;
      }
    });
  }
  
  function removeCnae(formElement) {
    if (confirm('Deseja remover este CNAE?')) {
      formElement.remove();
      formIndex--;
      updateTotalForms();
      reorderCnaes();
    }
  }
  
  function adicionarCnaeSecundario(codigo, descricao, ordem = null) {
    if (formIndex >= maxForms) {
      console.warn(`Máximo de ${maxForms} CNAEs atingido`);
      return false;
    }
    
    const container = document.getElementById('cnaes-container');
    const template = document.getElementById('cnae-template');
    const newForm = template.cloneNode(true);
    
    // Configurar novo formulário
    newForm.classList.remove('d-none');
    newForm.removeAttribute('id');
    newForm.setAttribute('data-form-index', formIndex);
    
    // Atualizar nomes e valores dos campos
    const inputs = newForm.querySelectorAll('input');
    inputs.forEach(input => {
      const name = input.getAttribute('name');
      if (name) {
        const newName = name.replace('__prefix__', `cnaes-${formIndex}`);
        input.setAttribute('name', newName);
        input.setAttribute('id', `id_cnaes-${formIndex}-${name.split('-')[1]}`);
        
        // Preencher valores
        if (name.includes('-codigo_cnae')) {
          input.value = codigo;
        } else if (name.includes('-descricao_cnae')) {
          input.value = descricao;
        } else if (name.includes('-ordem')) {
          input.value = ordem || (formIndex + 1);
        }
      }
    });
    
    container.appendChild(newForm);
    
    // Adicionar evento de remoção
    const removeBtn = newForm.querySelector('.remover-cnae');
    if (removeBtn) {
      removeBtn.addEventListener('click', function() {
        removeCnae(newForm);
      });
    }
    
    formIndex++;
    updateTotalForms();
    return true;
  }
  
  function popularCnaesSecundarios(cnaesSecundarios) {
    // Limpar CNAEs secundários existentes (apenas os não salvos)
    const container = document.getElementById('cnaes-container');
    const cnaesExistentes = container.querySelectorAll('.cnae-item:not(.d-none)');
    
    // Confirmar se deseja substituir CNAEs existentes
    if (cnaesExistentes.length > 0) {
      const confirmar = confirm(
        `Existem ${cnaesExistentes.length} CNAEs secundários cadastrados. ` +
        `Deseja substituí-los pelos ${cnaesSecundarios.length} CNAEs da Receita Federal?`
      );
      
      if (!confirmar) {
        return; // Usuário cancelou
      }
      
      // Remover CNAEs existentes que não estão salvos no banco
      cnaesExistentes.forEach(cnae => {
        const hasId = cnae.querySelector('input[name$="-id"]');
        if (!hasId || !hasId.value) {
          cnae.remove();
          formIndex--;
        }
      });
    }
    
    // Adicionar novos CNAEs da Receita
    let sucessos = 0;
    cnaesSecundarios.forEach((cnae, index) => {
      if (adicionarCnaeSecundario(cnae.codigo, cnae.descricao, index + 1)) {
        sucessos++;
      }
    });
    
    if (sucessos > 0) {
      // Mostrar mensagem de sucesso
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show';
      alertDiv.innerHTML = `
        <strong>CNAEs Adicionados!</strong> ${sucessos} CNAEs secundários da Receita Federal foram adicionados.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // Inserir antes do container de CNAEs
      const cnaesCard = document.querySelector('#cnaes-container').closest('.card');
      cnaesCard.parentNode.insertBefore(alertDiv, cnaesCard);
      
      // Remover alerta após 5 segundos
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
  }
  
  function updateCnaeDisplay() {
    const cnaePrincipalInput = document.getElementById('{{ form.cnae_principal.id_for_label }}');
    const cnaeDescricaoInput = document.getElementById('{{ form.cnae_descricao.id_for_label }}');
    const cnaeDisplay = document.getElementById('cnae-principal-display');
    
    const codigo = cnaePrincipalInput?.value || '';
    const descricao = cnaeDescricaoInput?.value || '';
    
    if (codigo) {
      cnaeDisplay.textContent = `${codigo}${descricao ? ' - ' + descricao : ''}`;
    } else {
      cnaeDisplay.textContent = 'Não informado';
    }
  }
  
  // ===== EVENT LISTENERS =====
  
  // Botão adicionar CNAE
  document.getElementById('adicionarCnae')?.addEventListener('click', function() {
    if (formIndex >= maxForms) {
      alert(`Máximo de ${maxForms} CNAEs permitidos`);
      return;
    }
    
    const container = document.getElementById('cnaes-container');
    const template = document.getElementById('cnae-template');
    const newForm = template.cloneNode(true);
    
    // Remover classe d-none e ID
    newForm.classList.remove('d-none');
    newForm.removeAttribute('id');
    newForm.setAttribute('data-form-index', formIndex);
    
    // Atualizar nomes dos campos
    const inputs = newForm.querySelectorAll('input');
    inputs.forEach(input => {
      const name = input.getAttribute('name');
      if (name) {
        input.setAttribute('name', name.replace('__prefix__', `cnaes-${formIndex}`));
        input.setAttribute('id', `id_cnaes-${formIndex}-${name.split('-')[1]}`);
      }
    });
    
    // Atualizar ordem automaticamente
    const ordemInput = newForm.querySelector('input[name$="-ordem"]');
    if (ordemInput) {
      ordemInput.value = formIndex + 1;
    }
    
    container.appendChild(newForm);
    
    // Atualizar total forms
    formIndex++;
    updateTotalForms();
    
    // Adicionar evento de remoção
    const removeBtn = newForm.querySelector('.remover-cnae');
    if (removeBtn) {
      removeBtn.addEventListener('click', function() {
        removeCnae(newForm);
      });
    }
  });
  
  // Botões de remoção existentes
  document.querySelectorAll('.remover-cnae').forEach(btn => {
    btn.addEventListener('click', function() {
      const formElement = btn.closest('.cnae-item');
      removeCnae(formElement);
    });
  });
  
  // Atualizar display do CNAE principal
  const cnaePrincipalInput = document.getElementById('{{ form.cnae_principal.id_for_label }}');
  const cnaeDescricaoInput = document.getElementById('{{ form.cnae_descricao.id_for_label }}');
  
  if (cnaePrincipalInput) {
    cnaePrincipalInput.addEventListener('input', updateCnaeDisplay);
  }
  
  if (cnaeDescricaoInput) {
    cnaeDescricaoInput.addEventListener('input', updateCnaeDisplay);
  }
  
  // ===== CONSULTA RECEITA FEDERAL ATUALIZADA =====
  
  const btnConsultarReceita = document.getElementById('consultarReceita');
  const cpfCnpjInput = document.getElementById('{{ form.cpf_cnpj.id_for_label }}');
  
  if (btnConsultarReceita && cpfCnpjInput) {
    btnConsultarReceita.addEventListener('click', function() {
      const cpfCnpj = cpfCnpjInput.value.trim().replace(/[^\d]/g, '');
      
      if (cpfCnpj) {
        btnConsultarReceita.disabled = true;
        btnConsultarReceita.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        fetch(`/gestor/api/consultar-receita/${cpfCnpj}/`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const dados = data.dados;
              
              // Preencher campos básicos
              if (dados.razaoSocial) document.getElementById('{{ form.nome_razao_social.id_for_label }}').value = dados.razaoSocial;
              if (dados.nomeFantasia) document.getElementById('{{ form.nome_fantasia.id_for_label }}').value = dados.nomeFantasia;
              if (dados.situacaoCadastral) document.getElementById('{{ form.situacao_cadastral.id_for_label }}').value = dados.situacaoCadastral;
              if (dados.naturezaJuridica) document.getElementById('{{ form.natureza_juridica.id_for_label }}').value = dados.naturezaJuridica;
              if (dados.porteEmpresa) document.getElementById('{{ form.porte_empresa.id_for_label }}').value = dados.porteEmpresa;
              if (dados.dataAbertura) document.getElementById('{{ form.data_abertura.id_for_label }}').value = dados.dataAbertura;
              
              // Preencher CNAE principal
              if (dados.cnaeFiscal) {
                document.getElementById('{{ form.cnae_principal.id_for_label }}').value = dados.cnaeFiscal;
                document.getElementById('{{ form.cnae_descricao.id_for_label }}').value = dados.cnaeFiscalDescricao || '';
                updateCnaeDisplay();
              }
              
              // Atualizar data da consulta
              document.getElementById('{{ form.data_ultima_verificacao.id_for_label }}').value = new Date().toISOString().slice(0, 16);
              
              // Atualizar opções tributárias
              if (dados.optanteSimples !== undefined) {
                document.getElementById('{{ form.opcao_pelo_simples.id_for_label }}').checked = dados.optanteSimples;
              }
              if (dados.optanteMei !== undefined) {
                document.getElementById('{{ form.opcao_pelo_mei.id_for_label }}').checked = dados.optanteMei;
              }
              
              // *** POPULAR CNAEs SECUNDÁRIOS ***
              if (dados.cnaesSecundarios && dados.cnaesSecundarios.length > 0) {
                popularCnaesSecundarios(dados.cnaesSecundarios);
              }
              
              alert(`Dados atualizados! CNAE principal + ${dados.cnaesSecundarios?.length || 0} CNAEs secundários`);
            } else {
              alert(data.message || 'Erro ao consultar dados na Receita Federal');
            }
          })
          .catch(error => {
            console.error('Erro na consulta:', error);
            alert('Erro ao realizar a consulta.');
          })
          .finally(() => {
            btnConsultarReceita.disabled = false;
            btnConsultarReceita.innerHTML = '<i class="fas fa-sync-alt"></i>';
          });
      } else {
        alert('Informe um CPF/CNPJ válido para consulta');
      }
    });
  }
  
  // ===== BUSCAR CLIENTE MASTER =====
  
  const btnBuscarMaster = document.getElementById('buscarMaster');
  const codigoMasterInput = document.getElementById('{{ form.codigo_master.id_for_label }}');
  const nomeClienteMaster = document.getElementById('nomeClienteMaster');
  
  if (btnBuscarMaster && codigoMasterInput) {
    btnBuscarMaster.addEventListener('click', function() {
      const codigoMaster = codigoMasterInput.value.trim();
      if (codigoMaster) {
        fetch(`/gestor/api/cliente-por-codigo/${codigoMaster}/`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              nomeClienteMaster.textContent = data.nome;
            } else {
              nomeClienteMaster.textContent = 'Cliente master não encontrado';
            }
          })
          .catch(error => {
            console.error('Erro ao buscar cliente master:', error);
            nomeClienteMaster.textContent = 'Erro ao buscar cliente master';
          });
      } else {
        nomeClienteMaster.textContent = '';
      }
    });
  }
});
</script>

{% endblock %}